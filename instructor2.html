<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚ö° Instructor ‚Äî Task 2</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080810;--bg-card:#0f0f1a;--bg-hover:#161624;
  --border:#1e1528;
  --red:#c41e3a;--red-bright:#e8334f;--red-dim:#3d0f1a;
  --gold:#c9a84c;--gold-dim:#6b5a2a;
  --green:#34c769;--green-dim:#1a3d28;
  --blue:#4a90d9;--blue-dim:#1a2d4a;
  --text:#e4dde0;--text2:#8a7e84;--text3:#4a4248;
  --font-head:'Oswald',sans-serif;--font-body:'Lora',serif;
}
html{font-size:15px}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);min-height:100vh}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 60% 40% at 15% 80%,rgba(196,30,58,.05) 0%,transparent 70%)}
.wrap{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:20px 24px 60px}

/* HEADER */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:16px 0 20px;border-bottom:1px solid var(--border);margin-bottom:24px}
.hdr-left h1{font-family:var(--font-head);font-size:1.6rem;font-weight:700;letter-spacing:.03em;text-transform:uppercase}
.hdr-left h1 span{color:var(--gold)}
.hdr-left .sub{font-size:.72rem;color:var(--text3);font-family:var(--font-head);letter-spacing:.12em;text-transform:uppercase;margin-top:2px}
.state-badge{font-family:var(--font-head);font-size:.85rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;padding:8px 18px;border-radius:6px;border:1px solid var(--border);color:var(--text3)}
.state-badge.task2{color:var(--gold);border-color:var(--gold);background:rgba(201,168,76,.06)}
.state-badge.task2_done{color:var(--green);border-color:var(--green);background:var(--green-dim)}
.state-badge.waiting{color:var(--text3);border-color:var(--text3)}
.state-badge.task1{color:var(--red-bright);border-color:var(--red);background:var(--red-dim)}
.state-badge.task1_done{color:var(--gold);border-color:var(--gold);background:rgba(201,168,76,.06)}

/* PANELS */
.panels{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.panel{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:20px}
.panel-title{font-family:var(--font-head);font-size:.72rem;letter-spacing:.15em;text-transform:uppercase;color:var(--text3);margin-bottom:14px;font-weight:600}
.panel.full{grid-column:1/-1}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 22px;border:none;border-radius:6px;font-family:var(--font-head);font-size:.78rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;transition:all .15s;margin:0 6px 8px 0}
.btn-red{background:var(--red);color:#fff}.btn-red:hover{background:var(--red-bright)}
.btn-out{background:transparent;border:1px solid var(--border);color:var(--text2)}.btn-out:hover{border-color:var(--text2);color:var(--text)}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{background:#3dd97a}
.btn-gold{background:var(--gold);color:#080810}.btn-gold:hover{background:#d9b85c}
.btn-danger{background:#661a1a;color:#d4a0a0;border:1px solid #4a1111}.btn-danger:hover{background:#7a2020}
.ctrl-row{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
.ctrl-divider{width:1px;height:28px;background:var(--border);margin:0 8px}

/* TIMER */
.timer-input{display:inline-flex;align-items:center;gap:6px}
.timer-input input{width:60px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:var(--font-head);font-size:.85rem;text-align:center}
.timer-input input:focus{border-color:var(--red);outline:none}
.timer-live{font-family:var(--font-head);font-size:4.5rem;letter-spacing:.08em;color:var(--text3);text-align:center;margin-top:12px;line-height:1}
.timer-live.active{color:var(--text)}
.timer-live.urgent{color:var(--red-bright);animation:timerPulse 1s infinite}
@keyframes timerPulse{0%,100%{opacity:1}50%{opacity:.4}}

/* SUBMISSIONS */
.sub-counter{font-family:var(--font-head);font-size:3.2rem;font-weight:700;color:var(--gold);line-height:1}
.sub-counter-label{font-family:var(--font-head);font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;color:var(--text3)}
.team-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:10px}
.team-chip{padding:6px 0;text-align:center;border:1px solid var(--border);border-radius:5px;font-family:var(--font-head);font-size:.72rem;font-weight:600;color:var(--text3)}
.team-chip.done{border-color:var(--green);color:var(--green);background:var(--green-dim)}

/* LOG */
.log{max-height:220px;overflow-y:auto;font-size:.78rem;color:var(--text3)}
.log-entry{padding:4px 0;border-bottom:1px solid rgba(30,21,40,.2)}
.log-entry .lt{color:var(--text3);font-family:monospace;margin-right:6px}
.log-entry .ln{color:var(--gold)}

/* FEUD BOARD */
.feud-board{display:flex;flex-direction:column;gap:6px}
.feud-slot{display:flex;align-items:center;height:54px;border-radius:8px;overflow:hidden;cursor:pointer;transition:all .2s;border:2px solid var(--border);background:var(--bg)}
.feud-slot:hover{border-color:var(--text2);background:var(--bg-hover)}
.feud-slot.sent{border-color:var(--gold);background:rgba(201,168,76,.05);cursor:default}
.feud-slot.sent:hover{background:rgba(201,168,76,.05)}
.feud-rank{width:50px;height:100%;display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-weight:700;font-size:1.2rem;flex-shrink:0;background:var(--border);color:var(--text3)}
.feud-slot.sent .feud-rank{background:var(--gold);color:#080810}
.feud-answer{flex:1;padding:0 14px;font-family:var(--font-head);font-size:1rem;font-weight:600;letter-spacing:.03em;text-transform:uppercase;color:var(--text)}
.feud-meta{padding-right:14px;text-align:right}
.feud-meta .fm-avg{font-family:var(--font-head);font-size:.75rem;color:var(--text2)}
.feud-meta .fm-type{font-family:var(--font-head);font-size:.52rem;letter-spacing:.08em;text-transform:uppercase;margin-top:1px}
.fm-type.physio{color:var(--red)}.fm-type.hemo{color:var(--blue)}
.feud-status{width:60px;text-align:center;font-family:var(--font-head);font-size:.6rem;letter-spacing:.08em;text-transform:uppercase;flex-shrink:0;padding-right:10px}
.feud-status.pending{color:var(--text3)}
.feud-status.live{color:var(--gold)}
.feud-ctrl{display:flex;gap:8px;align-items:center;margin-bottom:14px}
.feud-count{font-family:var(--font-head);font-size:.78rem;color:var(--text3)}

/* PROJECTOR CONTROLS */
.proj-ctrl{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.proj-btn{padding:8px 18px;border:1px solid var(--border);border-radius:5px;font-family:var(--font-head);font-size:.72rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;background:var(--bg);color:var(--text2);transition:all .15s}
.proj-btn:hover{border-color:var(--text2);color:var(--text)}
.proj-btn.on{border-color:var(--gold);color:var(--gold);background:var(--gold-dim)}

/* ANALYTICS TABS */
.atabs{display:flex;gap:4px;margin-bottom:14px}
.atab{padding:7px 16px;border:1px solid var(--border);border-radius:5px;font-family:var(--font-head);font-size:.72rem;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;color:var(--text3);background:var(--bg)}
.atab:hover{border-color:var(--text2);color:var(--text)}
.atab.on{border-color:var(--gold);color:var(--gold);background:var(--gold-dim)}
.ap{padding:12px 0}

/* HEATMAP */
.heatmap{overflow-x:auto}
.hm-table{border-collapse:collapse;width:100%;font-size:.72rem;font-family:var(--font-head)}
.hm-table th{padding:5px 6px;text-align:center;font-weight:600;color:var(--text3);font-size:.62rem;border-bottom:2px solid var(--border);background:var(--bg-card)}
.hm-table td{padding:4px 6px;text-align:center;border-bottom:1px solid rgba(30,21,40,.2)}
.hm-table td:first-child{text-align:left;font-weight:600;color:var(--text2)}
.hm-cell{display:inline-flex;align-items:center;justify-content:center;width:28px;height:24px;border-radius:4px;font-weight:700;font-size:.72rem}

/* SPLIT BAR */
.split-bar{height:36px;border-radius:8px;overflow:hidden;display:flex;margin:12px 0}
.split-seg{display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-size:.82rem;font-weight:600}
.split-seg.physio{background:linear-gradient(90deg,var(--red),var(--red-bright));color:#fff}
.split-seg.hemo{background:linear-gradient(90deg,var(--blue),#6ab0e8);color:#fff}

/* CONSIDERATIONS */
.con-team{margin-bottom:14px}
.con-team-name{font-family:var(--font-head);font-size:.75rem;letter-spacing:.1em;text-transform:uppercase;color:var(--gold);margin-bottom:4px}
.con-item{font-size:.86rem;color:var(--text2);padding:4px 0 4px 16px;border-left:2px solid var(--border);margin-bottom:5px;line-height:1.55}

/* NO DATA */
.no-data{color:var(--text3);font-size:.88rem;font-style:italic;padding:20px 0;text-align:center}

/* DEMO */
.demo-banner{display:none;background:var(--gold-dim);border:1px solid var(--gold);border-radius:8px;padding:10px 18px;margin-bottom:20px;text-align:center;font-family:var(--font-head);font-size:.8rem;letter-spacing:.06em;color:var(--gold)}
.demo-banner.show{display:block}

@media(max-width:800px){.panels{grid-template-columns:1fr}.team-grid{grid-template-columns:repeat(3,1fr)}}
</style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="hdr">
    <div class="hdr-left">
      <h1>Task 2 ‚Äî Would've, Could've, <span>Should've</span></h1>
      <div class="sub">Instructor Dashboard</div>
    </div>
    <div class="state-badge" id="stateBadge">WAITING</div>
  </div>

  <!-- DEMO BANNER -->
  <div class="demo-banner" id="demoBanner">üé≠ DEMO MODE ‚Äî Simulated data. Open projector_2.html in another tab to see the student view.</div>

  <!-- GAME CONTROLS + TIMER -->
  <div class="panels">
    <div class="panel">
      <div class="panel-title">Game Controls</div>
      <div class="ctrl-row">
        <button class="btn btn-red" id="startBtn" onclick="doStartTask2()">‚ñ∂ Start Task 2</button>
        <button class="btn btn-out" id="freezeBtn" onclick="doToggleFreeze()">‚è∏ Freeze</button>
        <button class="btn btn-danger" onclick="doEndTask2()">‚èπ End Task 2</button>
      </div>
      <div class="ctrl-row" style="margin-top:10px">
        <button class="btn btn-out" onclick="doSetState('task1_done')">‚üµ Task 1 Done</button>
        <div class="ctrl-divider"></div>
        <button class="btn btn-gold" onclick="runDemo()">üé≠ Demo</button>
        <div class="ctrl-divider"></div>
        <button class="btn btn-danger" onclick="doResetTask2()">Reset Task 2</button>
        <button class="btn btn-danger" onclick="doResetAll()">Reset All</button>
      </div>
    </div>
    <div class="panel">
      <div class="panel-title">Timer</div>
      <div class="ctrl-row" style="align-items:flex-end">
        <div class="timer-input">
          <div>
            <label style="font-family:var(--font-head);font-size:.7rem;color:var(--text3);letter-spacing:.08em;text-transform:uppercase">Minutes</label>
            <input type="number" id="timerMin" value="10" min="1" max="60">
          </div>
        </div>
        <button class="btn btn-red" onclick="doStartTimer()">Start Timer</button>
        <button class="btn btn-out" onclick="doClearTimer()">Clear</button>
      </div>
      <div class="timer-live" id="timerLive">--:--</div>
    </div>
  </div>

  <!-- SUBMISSIONS + LOG -->
  <div class="panels">
    <div class="panel">
      <div class="panel-title">Submissions</div>
      <div style="display:flex;align-items:center;gap:16px">
        <div><div class="sub-counter" id="subCount">0</div><div class="sub-counter-label">of <span id="subTotal">15</span> teams</div></div>
      </div>
      <div class="team-grid" id="teamGrid"></div>
    </div>
    <div class="panel">
      <div class="panel-title">Live Log</div>
      <div class="log" id="logBox">Waiting for submissions‚Ä¶</div>
    </div>
  </div>

  <!-- PROJECTOR SCREEN CONTROL -->
  <div class="panels">
    <div class="panel full">
      <div class="panel-title">Projector Screen</div>
      <div class="proj-ctrl">
        <button class="proj-btn on" id="pb_0" onclick="sendScreen(0)">Timer</button>
        <button class="proj-btn" id="pb_1" onclick="sendScreen(1)">Feud Board</button>
        <button class="proj-btn" id="pb_2" onclick="sendScreen(2)">Heat Map</button>
        <button class="proj-btn" id="pb_3" onclick="sendScreen(3)">Physio vs Hemo</button>
        <button class="proj-btn" id="pb_4" onclick="sendScreen(4)">Considerations</button>
      </div>
    </div>
  </div>

  <!-- FEUD BOARD -->
  <div class="panels">
    <div class="panel full">
      <div class="panel-title">Family Feud ‚Äî Top 8 Consensus <span style="color:var(--text3);font-weight:400">(click a slot to reveal on projector)</span></div>
      <div class="feud-ctrl">
        <button class="btn btn-out" onclick="resetReveals()">Reset All Reveals</button>
        <span class="feud-count" id="feudCount">0 / 8 revealed</span>
      </div>
      <div class="feud-board" id="feudBoard">
        <div class="no-data">Waiting for submissions‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- ANALYTICS -->
  <div class="panels">
    <div class="panel full">
      <div class="panel-title">Analytics (Instructor Reference)</div>
      <div class="atabs">
        <div class="atab on" onclick="aGo(0,this)">Heat Map</div>
        <div class="atab" onclick="aGo(1,this)">Physio vs Hemo</div>
        <div class="atab" onclick="aGo(2,this)">Considerations</div>
      </div>
      <div class="ap" id="ap0" style="display:block"><div class="no-data">Waiting for submissions‚Ä¶</div></div>
      <div class="ap" id="ap1" style="display:none"><div class="no-data">Waiting for submissions‚Ä¶</div></div>
      <div class="ap" id="ap2" style="display:none"><div class="no-data">Waiting for submissions‚Ä¶</div></div>
    </div>
  </div>

</div>

<script>
// ==================== CONFIG ====================
const BACKEND = 'https://script.google.com/macros/s/AKfycbx_pEtSHZpfoCO--fsUljx04B7Hl8bYN4btYs_8Y_8jVrNckUu8KY1pIOIada5F_P52/exec';
const POLL_MS = 2000;

// Constraint metadata
const C = {
  C1:{n:'MAP',f:'Mean Arterial Pressure'},
  C2:{n:'CO',f:'Cardiac Output'},
  C3:{n:'CVP',f:'Central Venous Pressure'},
  C4:{n:'PCWP',f:'Pulmonary Capillary Wedge Pressure'},
  C5:{n:'SvO\u2082',f:'Mixed Venous O\u2082 Sat'},
  C6:{n:'Creatinine',f:'Serum Creatinine'},
  C7:{n:'Lactate',f:'Serum Lactate'},
  C8:{n:'HR',f:'Heart Rate'},
  C9:{n:'Flow Ratio',f:'Pump Flow vs Native Heart'},
  C10:{n:'AV Opening',f:'Aortic Valve Opening'},
  C11:{n:'PI',f:'Pulsatility Index'},
  C12:{n:'LVEDD',f:'LV End-Diastolic Dimension'}
};
const IDS = ['C1','C2','C3','C4','C5','C6','C7','C8','C9','C10','C11','C12'];
const PHY = ['C1','C2','C3','C4','C5','C6','C7','C8']; // physiological
const FCOUNT = 8; // top 8 for feud

// ==================== STATE ====================
let currentState = 'waiting';
let frozen = false;
let timerEnd = null;
let timerInterval = null;
let pollTimer = null;
let demoMode = false;

// Feud reveal tracking
let revealedSlots = {}; // {0: true, 3: true, ...}
let currentScreen = 0;  // 0=timer, 1=feud, 2=heatmap, 3=split, 4=considers

// Cached data from backend
let cachedReveal = null;
let lastSubCount = 0;

// ==================== API (JSONP) ====================
let cbCount = 0;
function api(action, params, cb) {
  const name = '_i2cb' + (cbCount++);
  window[name] = function(d) { delete window[name]; if (cb) cb(d); };
  let url = BACKEND + '?callback=' + name + '&action=' + action;
  if (params) for (const k in params) url += '&' + encodeURIComponent(k) + '=' + encodeURIComponent(params[k]);
  const s = document.createElement('script');
  s.src = url;
  s.onerror = function() { delete window[name]; };
  document.body.appendChild(s);
  setTimeout(function() { if (s.parentNode) s.parentNode.removeChild(s); }, 10000);
}

// ==================== POLLING ====================
function startPolling() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(pollAll, POLL_MS);
  pollAll();
}

function pollAll() {
  if (demoMode) return;
  api('getState', null, handleState);
  api('getTask2Reveal', null, handleRevealData);
}

function handleState(d) {
  if (d.error || demoMode) return;

  // State badge
  currentState = d.game_state || 'waiting';
  const badge = document.getElementById('stateBadge');
  badge.textContent = currentState.toUpperCase().replace('_',' ');
  badge.className = 'state-badge ' + currentState;

  // Freeze
  frozen = d.freeze === true || d.freeze === 'true';
  const fb = document.getElementById('freezeBtn');
  fb.textContent = frozen ? '‚ñ∂ Unfreeze' : '‚è∏ Freeze';
  fb.className = frozen ? 'btn btn-green' : 'btn btn-out';

  // Timer
  if (d.timer_end) {
    timerEnd = new Date(d.timer_end).getTime();
    if (!timerInterval) {
      timerInterval = setInterval(updateTimer, 500);
      updateTimer();
    }
  } else {
    timerEnd = null;
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    document.getElementById('timerLive').textContent = '--:--';
    document.getElementById('timerLive').className = 'timer-live';
  }

  // Read projector screen from task2_reveal_step
  // Encoding: step = screenId * 100 + bitmask (for reveal slots stored in timer_label)
  // Actually: we read the screen + reveals from timer_label when in task2/task2_done
  if (d.timer_label && d.timer_label.indexOf('t2scr:') === 0) {
    // Parse: "t2scr:1:0,2,5" ‚Üí screen=1, revealed=[0,2,5]
    var parts = d.timer_label.substring(6).split(':');
    var scr = parseInt(parts[0]);
    if (!isNaN(scr) && scr >= 0 && scr <= 4) {
      currentScreen = scr;
      highlightProjBtn(scr);
    }
    if (parts[1]) {
      var slots = parts[1].split(',').filter(function(s){return s!==''});
      revealedSlots = {};
      for (var i = 0; i < slots.length; i++) {
        var idx = parseInt(slots[i]);
        if (!isNaN(idx)) revealedSlots[idx] = true;
      }
    }
  }
}

function updateTimer() {
  if (!timerEnd) return;
  const remaining = Math.max(0, timerEnd - Date.now());
  const mins = Math.floor(remaining / 60000);
  const secs = Math.floor((remaining % 60000) / 1000);
  const el = document.getElementById('timerLive');
  el.textContent = mins + ':' + String(secs).padStart(2, '0');
  el.className = 'timer-live' + (remaining > 0 ? ' active' : '') + (remaining < 60000 && remaining > 0 ? ' urgent' : '');
}

// ==================== HANDLE REVEAL DATA ====================
function handleRevealData(d) {
  if (d.error || demoMode) return;
  cachedReveal = d;

  // Update submission counter
  var subCount = d.submittedCount || 0;
  var totalTeams = d.totalTeams || 15;
  document.getElementById('subCount').textContent = subCount;
  document.getElementById('subTotal').textContent = totalTeams;

  // Team grid
  renderTeamGrid(d);

  // Log
  if (subCount !== lastSubCount) {
    renderLog(d);
    lastSubCount = subCount;
  }

  // Feud board
  if (d.classConsensus && d.classConsensus.length > 0) {
    buildBoard(d.classConsensus);
  }

  // Analytics
  renderHeatmap(d);
  renderSplit(d);
  renderConsiders(d);
}

// ==================== TEAM GRID ====================
function renderTeamGrid(d) {
  var el = document.getElementById('teamGrid');
  // Figure out which teams submitted
  var submitted = {};
  if (d.heatMap) {
    for (var i = 0; i < d.heatMap.length; i++) {
      submitted[d.heatMap[i].teamName] = true;
    }
  }
  var html = '';
  for (var g = 1; g <= 15; g++) {
    var name = 'Group ' + g;
    var done = submitted[name] ? true : false;
    html += '<div class="team-chip' + (done ? ' done' : '') + '">' + g + (done ? ' ‚úì' : '') + '</div>';
  }
  el.innerHTML = html;
}

// ==================== LOG ====================
function renderLog(d) {
  var el = document.getElementById('logBox');
  if (!d.heatMap || d.heatMap.length === 0) {
    el.innerHTML = 'Waiting for submissions‚Ä¶';
    return;
  }
  var html = '';
  // Show submissions in reverse order (most recent first)
  var teams = d.heatMap.slice().reverse();
  for (var i = 0; i < teams.length; i++) {
    var t = teams[i];
    var rankCount = 0;
    for (var k in t.rankings) rankCount++;
    // Count considerations
    var conCount = 0;
    if (d.considerations && d.considerations[t.teamName]) {
      conCount = d.considerations[t.teamName].length;
    }
    html += '<div class="log-entry"><span class="ln">' + t.teamName + '</span> submitted (' + rankCount + ' ranked' + (conCount > 0 ? ', ' + conCount + ' considerations' : '') + ')</div>';
  }
  el.innerHTML = html;
}

// ==================== FEUD BOARD ====================
function buildBoard(consensus) {
  var b = document.getElementById('feudBoard');
  var html = '';
  var count = Math.min(FCOUNT, consensus.length);

  for (var i = 0; i < count; i++) {
    var s = consensus[i];
    var cData = C[s.id] || { n: s.id, f: s.id };
    var isPhysio = PHY.indexOf(s.id) >= 0;
    var sent = revealedSlots[i] ? true : false;

    html += '<div class="feud-slot' + (sent ? ' sent' : '') + '" id="fs' + i + '" onclick="revealSlot(' + i + ')">';
    html += '<div class="feud-rank">' + (i + 1) + '</div>';
    html += '<div class="feud-answer">' + s.id + ' \u2014 ' + cData.n + '</div>';
    html += '<div class="feud-meta"><div class="fm-avg">Avg ' + s.avgRank + '</div><div class="fm-type ' + (isPhysio ? 'physio' : 'hemo') + '">' + (isPhysio ? 'Physiological' : 'LVAD Hemo') + '</div></div>';
    html += '<div class="feud-status ' + (sent ? 'live' : 'pending') + '">' + (sent ? '\u2713 LIVE' : 'click to reveal') + '</div>';
    html += '</div>';
  }
  b.innerHTML = html;
  updCount();
}

function revealSlot(i) {
  if (revealedSlots[i]) return;
  revealedSlots[i] = true;

  // Update local UI
  var slot = document.getElementById('fs' + i);
  if (slot) {
    slot.className = 'feud-slot sent';
    slot.querySelector('.feud-status').className = 'feud-status live';
    slot.querySelector('.feud-status').textContent = '\u2713 LIVE';
  }

  // Auto-switch projector to feud
  currentScreen = 1;
  syncProjState();
  updCount();
}

function resetReveals() {
  revealedSlots = {};
  syncProjState();
  // Rebuild board from cached data
  if (cachedReveal && cachedReveal.classConsensus) {
    buildBoard(cachedReveal.classConsensus);
  }
}

function updCount() {
  var n = 0;
  for (var k in revealedSlots) if (revealedSlots[k]) n++;
  document.getElementById('feudCount').textContent = n + ' / ' + FCOUNT + ' revealed';
}

// ==================== PROJECTOR SCREEN SYNC ====================
// Encode screen + revealed slots into timer_label for projector to read
// Format: "t2scr:SCREEN:SLOT1,SLOT2,SLOT3"
function syncProjState() {
  var slotsArr = [];
  for (var k in revealedSlots) {
    if (revealedSlots[k]) slotsArr.push(k);
  }
  var label = 't2scr:' + currentScreen + ':' + slotsArr.join(',');

  if (demoMode) {
    // In demo mode, just update local highlights
    highlightProjBtn(currentScreen);
    return;
  }

  // Write to backend via setTimer (preserves existing timer_end, just updates label)
  // Actually setTimer requires seconds param. Use a workaround:
  // We'll set a dummy timer_label by calling setTimer with remaining seconds
  if (timerEnd) {
    var remaining = Math.max(1, Math.ceil((timerEnd - Date.now()) / 1000));
    api('setTimer', { seconds: remaining, label: label });
  } else {
    // No timer active ‚Äî set a very long timer just to store the label
    // Or better: directly call setTimer with 1 second (it'll expire immediately but label persists)
    api('setTimer', { seconds: 36000, label: label }); // 10hr placeholder
  }
  highlightProjBtn(currentScreen);
}

function sendScreen(screenId) {
  currentScreen = screenId;
  syncProjState();
}

function highlightProjBtn(screenId) {
  for (var i = 0; i <= 4; i++) {
    var btn = document.getElementById('pb_' + i);
    if (btn) btn.className = (i === screenId) ? 'proj-btn on' : 'proj-btn';
  }
}

// ==================== ANALYTICS ====================
function aGo(n, btn) {
  var tabs = document.querySelectorAll('.atab');
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].className = 'atab';
    document.getElementById('ap' + i).style.display = 'none';
  }
  btn.className = 'atab on';
  document.getElementById('ap' + n).style.display = 'block';
}

// HEAT MAP
function renderHeatmap(d) {
  var el = document.getElementById('ap0');
  if (!d.heatMap || d.heatMap.length === 0) {
    el.innerHTML = '<div class="no-data">Waiting for submissions‚Ä¶</div>';
    return;
  }

  var consensus = d.classConsensus || [];
  var cols = consensus.map(function(c) { return c.id; });

  var html = '<div class="heatmap"><table class="hm-table"><tr><th style="text-align:left">Team</th>';
  for (var c = 0; c < cols.length; c++) html += '<th>' + cols[c] + '</th>';
  html += '</tr>';

  for (var t = 0; t < d.heatMap.length; t++) {
    var team = d.heatMap[t];
    html += '<tr><td>' + team.teamName.replace('Group ', 'G') + '</td>';
    for (var c = 0; c < cols.length; c++) {
      var rk = team.rankings[cols[c]];
      if (rk) {
        var hu = rk <= 3 ? 140 : rk <= 6 ? 80 : rk <= 9 ? 35 : 0;
        var li = rk <= 3 ? 20 : 22;
        html += '<td><span class="hm-cell" style="background:hsl(' + hu + ',65%,' + li + '%);color:hsl(' + hu + ',65%,' + (li + 35) + '%)">' + rk + '</span></td>';
      } else {
        html += '<td><span class="hm-cell" style="background:var(--border);color:var(--text3)">‚Äî</span></td>';
      }
    }
    html += '</tr>';
  }
  html += '</table></div>';
  el.innerHTML = html;
}

// PHYSIO VS HEMO
function renderSplit(d) {
  var el = document.getElementById('ap1');
  if (!d.physioVsHemo || d.physioVsHemo.totalTop4Slots === 0) {
    el.innerHTML = '<div class="no-data">Waiting for submissions‚Ä¶</div>';
    return;
  }

  var pv = d.physioVsHemo;
  var total = pv.totalTop4Slots || 1;
  var pp = Math.round(pv.physioInTop4 / total * 100);
  var hp = 100 - pp;

  var html = '<p style="color:var(--text2);font-size:.88rem;margin-bottom:14px;line-height:1.55">When teams ranked their <strong>top 4</strong> constraints, how did they split between <span style="color:var(--red)">physiological</span> and <span style="color:var(--blue)">LVAD hemodynamic</span>?</p>';
  html += '<div class="split-bar"><div class="split-seg physio" style="width:' + pp + '%">' + pp + '% Physio</div><div class="split-seg hemo" style="width:' + hp + '%">' + hp + '% Hemo</div></div>';
  html += '<div style="display:flex;justify-content:space-between;font-size:.82rem;color:var(--text2);margin-top:8px"><span><strong>' + pv.physioInTop4 + '</strong> physiological</span><span><strong>' + pv.hemoInTop4 + '</strong> hemodynamic</span></div>';
  html += '<div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)"><p style="font-family:var(--font-head);font-size:.68rem;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);margin-bottom:8px">Discussion Prompt</p><p style="color:var(--text2);font-size:.88rem;line-height:1.55">Most teams prioritize physiological targets \u2014 keeping the <em>body</em> alive. But the LVAD hemodynamic constraints tell you whether the <em>device-heart partnership</em> is working. What happens if you nail the physiology numbers but the aortic valve never opens?</p></div>';

  el.innerHTML = html;
}

// CONSIDERATIONS
function renderConsiders(d) {
  var el = document.getElementById('ap2');
  if (!d.considerations || Object.keys(d.considerations).length === 0) {
    el.innerHTML = '<div class="no-data">Waiting for submissions‚Ä¶</div>';
    return;
  }

  var html = '';
  for (var teamName in d.considerations) {
    var cons = d.considerations[teamName];
    if (!cons || cons.length === 0) continue;
    html += '<div class="con-team"><div class="con-team-name">' + teamName + '</div>';
    for (var j = 0; j < cons.length; j++) {
      html += '<div class="con-item">' + cons[j] + '</div>';
    }
    html += '</div>';
  }

  el.innerHTML = html || '<div class="no-data">No considerations submitted yet</div>';
}

// ==================== ACTIONS ====================
function doStartTask2() {
  var mins = parseInt(document.getElementById('timerMin').value) || 10;
  api('setState', { state: 'task2' }, function(d) {
    if (d.error) { alert('Error: ' + d.error); return; }
    // Start timer + encode projector screen as timer
    currentScreen = 0;
    revealedSlots = {};
    var label = 't2scr:0:';
    api('setTimer', { seconds: mins * 60, label: label }, function() {
      api('setFreeze', { frozen: 'false' }, function() {
        pollAll();
      });
    });
  });
}

function doToggleFreeze() {
  api('setFreeze', { frozen: frozen ? 'false' : 'true' }, function(d) {
    if (d.error) { alert('Error: ' + d.error); return; }
    pollAll();
  });
}

function doEndTask2() {
  if (!confirm('End Task 2? This will stop the game.')) return;
  api('setFreeze', { frozen: 'false' }, function() {
    api('setState', { state: 'task2_done' }, function(d) {
      if (d.error) { alert('Error: ' + d.error); return; }
      pollAll();
    });
  });
}

function doStartTimer() {
  var mins = parseInt(document.getElementById('timerMin').value) || 10;
  var label = 't2scr:' + currentScreen + ':';
  var slotsArr = [];
  for (var k in revealedSlots) if (revealedSlots[k]) slotsArr.push(k);
  label += slotsArr.join(',');
  api('setTimer', { seconds: mins * 60, label: label }, function(d) {
    if (d.error) { alert('Error: ' + d.error); return; }
    pollAll();
  });
}

function doClearTimer() {
  // Keep the projector state by NOT clearing label ‚Äî but clearTimer wipes it
  // So sync projector state after clearing
  api('clearTimer', null, function(d) {
    // Re-set projector state via a long placeholder timer
    syncProjState();
    pollAll();
  });
}

function doSetState(state) {
  api('setState', { state: state }, function(d) {
    if (d.error) { alert('Error: ' + d.error); return; }
    pollAll();
  });
}

function doResetTask2() {
  if (!confirm('Reset Task 2? This clears all rankings and considerations but keeps team names.')) return;
  api('resetTask2', null, function(d) {
    if (d.error) { alert('Error: ' + d.error); return; }
    revealedSlots = {};
    cachedReveal = null;
    lastSubCount = 0;
    alert(d.message);
    pollAll();
  });
}

function doResetAll() {
  if (!confirm('NUCLEAR RESET ‚Äî clear everything including teams?')) return;
  if (!confirm('Are you sure? This is irreversible.')) return;
  api('resetAll', null, function(d) {
    if (d.error) { alert('Error: ' + d.error); return; }
    revealedSlots = {};
    cachedReveal = null;
    lastSubCount = 0;
    alert(d.message);
    pollAll();
  });
}

// ==================== DEMO MODE ====================
function runDemo() {
  if (demoMode) {
    // Toggle off
    demoMode = false;
    document.getElementById('demoBanner').classList.remove('show');
    startPolling();
    return;
  }

  demoMode = true;
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
  document.getElementById('demoBanner').classList.add('show');
  revealedSlots = {};
  currentScreen = 0;
  highlightProjBtn(0);

  // State badge
  currentState = 'task2';
  var badge = document.getElementById('stateBadge');
  badge.textContent = 'TASK 2 (DEMO)';
  badge.className = 'state-badge task2';

  // Demo timer
  timerEnd = Date.now() + 10 * 60 * 1000;
  if (!timerInterval) {
    timerInterval = setInterval(updateTimer, 500);
    updateTimer();
  }

  // Generate fake data matching demo format
  var SUB = [1, 2, 3, 5, 7, 8, 11, 14];
  var TEAMS = [];
  for (var g = 0; g < SUB.length; g++) {
    var order = IDS.slice();
    shuffle(order);
    var rk = {};
    for (var r = 0; r < order.length; r++) rk[order[r]] = r + 1;
    var co = ['Patient quality of life and psychological well-being', 'Caregiver burden and training requirements', 'Health equity \u2014 access to specialized LVAD centers'];
    if (Math.random() > 0.5) co.pop();
    TEAMS.push({ name: 'Group ' + SUB[g], rk: rk, co: co });
  }

  // Build aggregated stats
  var st = {};
  for (var i = 0; i < IDS.length; i++) st[IDS[i]] = { n: 0, s: 0 };
  for (var t = 0; t < TEAMS.length; t++) {
    for (var c = 0; c < IDS.length; c++) {
      var id = IDS[c];
      st[id].n++;
      st[id].s += TEAMS[t].rk[id];
    }
  }
  var SORTED = IDS.map(function(id) {
    return { id: id, avgRank: Math.round(st[id].s / st[id].n * 10) / 10 };
  }).sort(function(a, b) { return a.avgRank - b.avgRank; });

  // Physio vs hemo
  var pT4 = 0, hT4 = 0, tT4 = 0;
  for (var t = 0; t < TEAMS.length; t++) {
    for (var c = 0; c < IDS.length; c++) {
      if (TEAMS[t].rk[IDS[c]] <= 4) {
        tT4++;
        if (PHY.indexOf(IDS[c]) >= 0) pT4++;
        else hT4++;
      }
    }
  }

  // Build heatMap
  var heatMap = [];
  for (var t = 0; t < TEAMS.length; t++) {
    heatMap.push({ teamName: TEAMS[t].name, rankings: TEAMS[t].rk });
  }

  // Build considerations
  var considerations = {};
  for (var t = 0; t < TEAMS.length; t++) {
    considerations[TEAMS[t].name] = TEAMS[t].co;
  }

  // Create fake reveal data
  cachedReveal = {
    submittedCount: SUB.length,
    totalTeams: 15,
    classConsensus: SORTED,
    heatMap: heatMap,
    physioVsHemo: { physioInTop4: pT4, hemoInTop4: hT4, totalTop4Slots: tT4 },
    considerations: considerations
  };

  // Render everything
  document.getElementById('subCount').textContent = SUB.length;
  document.getElementById('subTotal').textContent = '15';
  renderTeamGrid(cachedReveal);
  renderLog(cachedReveal);
  buildBoard(SORTED);
  renderHeatmap(cachedReveal);
  renderSplit(cachedReveal);
  renderConsiders(cachedReveal);
  lastSubCount = SUB.length;
}

function shuffle(arr) {
  for (var i = arr.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var tmp = arr[i];
    arr[i] = arr[j];
    arr[j] = tmp;
  }
}

// ==================== INIT ====================
// Render empty team grid
(function() {
  var el = document.getElementById('teamGrid');
  var html = '';
  for (var i = 1; i <= 15; i++) {
    html += '<div class="team-chip">' + i + '</div>';
  }
  el.innerHTML = html;
})();

startPolling();
</script>
</body>
</html>
